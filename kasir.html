<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kasir</title>
 <style>
  body { margin:0; font-family:sans-serif; background:#e0f7ff; color:#333; }
  header { background:#2196f3; color:#fff; padding:10px; text-align:center; font-size:1.2em; }
  .container { display:flex; flex-wrap:wrap; height:calc(100vh - 50px); }
  .sidebar, .menu, .order { padding:10px; box-sizing:border-box; overflow:auto; }
  .sidebar { flex:1; min-width:150px; background:#bbdefb; }
  .menu { flex:2; min-width:200px; background:#e3f2fd; display:grid; gap:10px; justify-content:start; }
  .order { flex:2; min-width:200px; background:#f1f8ff; display:flex; flex-direction:column; }
  .btn { display:block; width:100%; padding:8px; margin:5px 0; background:#2196f3; color:#fff; border:none; border-radius:6px; cursor:pointer; font-size:0.9em; }
  .btn:hover { background:#1976d2; }
  .card { background:#fff; height:150px; padding:10px; border-radius:8px; text-align:center; cursor:pointer; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
  .card:hover { background:#e1f5fe; }
  .card img { width:90px; height:90px; object-fit:cover; border-radius:8px; margin-bottom:5px; }
  .order-list { flex:1; overflow:auto; margin-bottom:10px; height:100%; width: 100%; right: 0%;}
  .order-item { display:flex; justify-content:space-between; align-items:center; padding:5px; border-bottom:1px solid #ccc; }
  .order-item span { font-size:0.9em; }
  .order-actions { display:flex; justify-content:space-between; gap:5px; }
  .input, select { width:100%; padding:6px; margin:4px 0; border:1px solid #ccc; border-radius:6px; }
  .popup { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:none; align-items:center; justify-content:center; z-index:10; }
  .popup-content { background:#fff; padding:20px; border-radius:8px; max-width:350px; width:90%; text-align:center; }
  .spinner { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); border:6px solid #ccc; border-top:6px solid #2196f3; border-radius:50%; width:50px; height:50px; animation:spin 1s linear infinite; }
  @keyframes spin { 100% { transform:translate(-50%,-50%) rotate(360deg); } }
  #strukPreview { text-align:left; font-size:0.9em; white-space:pre-wrap; font-family:monospace; }
  #strukPreview hr { border:none; border-top:1px dashed #aaa; margin:5px 0; }

  /* ====================== RESPONSIVE ====================== */

  /* Default desktop (tetap 4 kolom) */
  @media (min-width: 1025px) {
    .menu { grid-template-columns: repeat(4, 1fr); }
  }

  /* Portrait HP → 3 kolom */
  @media (max-width: 768px) and (orientation: portrait) {
    .container { flex-direction: column; height:auto; }
    .sidebar { flex:none; width:100%; display:flex; flex-wrap:wrap; gap:5px; margin-bottom:5px; }
    .sidebar .btn { flex:1 1 calc(50% - 5px); margin:2px 0; font-size:0.8em; }
    .menu { gap:5px; grid-template-columns: repeat(3, 1fr); }
    .card { height:120px; font-size:0.85em; }
    .order { width:100%; }
  }

  /* ✅ HP Landscape → tombol pindah ke atas, 4 kolom menu */
  @media (max-width: 760px) and (orientation: landscape) {
    .container { flex-direction: column; height:auto; }
    .sidebar {
      flex:none;
      order:-1;
      width:100%;
      background:#bbdefb;
      display:flex;
      justify-content:center;
      flex-wrap:wrap;
      gap:5px;
      padding:5px;
    }
    .sidebar .btn {
      flex:1 1 calc(20% - 5px);
      margin:2px;
      font-size:0.8em;
      padding:6px;
    }
    .menu {
      grid-template-columns: repeat(4, 1fr);
      gap:6px;
    }
    .card {
      height:120px;
      font-size:0.8em;
    }
    .card img {
      width:70px;
      height:70px;
    }
  }

  /* ✅ Tablet Landscape (769px–1024px) → 5 kolom */
  @media (min-width: 769px) and (max-width: 1024px) and (orientation: landscape) {
    .sidebar {
      flex:none;
      order:-1;
      width:100%;
      display:flex;
      justify-content:center;
      flex-wrap:wrap;
      gap:8px;
      padding:8px;
    }
    .sidebar .btn {
      flex:1 1 calc(16% - 8px);
      font-size:0.9em;
    }
    .menu {
      grid-template-columns: repeat(4, 1fr);
      gap:8px;
    }
    .card {
      height:130px;
    }
    .card img {
      width:80px;
      height:80px;
    }
  }
</style>

</head>
<body>
  <header id="restoName">Kasir</header>

  <div class="container">
    <!-- Sidebar -->
    <div class="sidebar">
      <button class="btn" onclick="filterMenu('Semua')">Semua</button>
      <button class="btn" onclick="filterMenu('Makanan')">Makanan</button>
      <button class="btn" onclick="filterMenu('Minuman')">Minuman</button>
      <button class="btn" onclick="filterMenu('Cemilan')">Cemilan</button>
      <button class="btn" onclick="openPopup('pengeluaranPopup')">+ Pengeluaran</button>
      <button class="btn" onclick="logout()">⬅ Kembali</button>
    </div>

    <!-- Menu -->
    <div class="menu" id="menuList"></div>

    <!-- Order -->
    <div class="order">
      <div class="order-list" id="orderList"></div>
      <div>
        <p>Total: Rp <span id="total">0</span></p>
        <input type="number" id="diskon" class="input" placeholder="Diskon (Rp)" oninput="hitungKembalian()">
        <input type="number" id="bayar" class="input" placeholder="Bayar" oninput="hitungKembalian()">
        <p>Kembalian: Rp <span id="kembalian">0</span></p>
        <div class="order-actions">
          <button class="btn" onclick="openPopup('resetPopup')">Reset</button>
          <button class="btn" onclick="konfirmasiBayar()">Bayar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Popup dan Spinner -->
  <div class="popup" id="loginPopup">
    <div class="popup-content">
      <h3>Login Kasir</h3>
      <input type="text" id="username" class="input" placeholder="Username">
      <input type="password" id="password" class="input" placeholder="Password">
      <button class="btn" onclick="login()">Login</button>
    </div>
  </div>

  <div class="popup" id="pengeluaranPopup">
    <div class="popup-content">
      <h3>Input Pengeluaran</h3>
      <input type="text" id="ketPengeluaran" class="input" placeholder="Keterangan">
      <input type="number" id="jumlahPengeluaran" class="input" placeholder="Jumlah">
      <input type="number" id="hargaPengeluaran" class="input" placeholder="Harga">
      <button class="btn" onclick="simpanPengeluaran()">Simpan</button>
      <button class="btn" onclick="closePopup('pengeluaranPopup')">Batal</button>
    </div>
  </div>

  <div class="popup" id="resetPopup">
    <div class="popup-content">
      <p>Yakin reset semua pesanan?</p>
      <button class="btn" onclick="resetPesanan()">Ya</button>
      <button class="btn" onclick="closePopup('resetPopup')">Batal</button>
    </div>
  </div>

  <div class="popup" id="cetakPopup">
    <div class="popup-content">
      <p>Cetak struk sekarang?</p>
      <button class="btn" onclick="lanjutBayar(true)">Ya</button>
      <button class="btn" onclick="lanjutBayar(false)">Tidak</button>
    </div>
  </div>

  <div class="popup" id="previewPopup">
    <div class="popup-content">
      <div id="strukPreview"></div>
      <button class="btn" id="btnCetakSekarang" onclick="cetakStruk()">Cetak Sekarang</button>
      <button class="btn" onclick="closePopup('previewPopup')">Batal</button>
    </div>
  </div>

  <div class="popup" id="notifPopup">
    <div class="popup-content">
      <p id="notifMessage"></p>
      <button class="btn" onclick="closePopup('notifPopup')">OK</button>
    </div>
  </div>

  <div class="spinner" id="spinner"></div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://dxcaivedoitovhjtyhxe.supabase.co";
    const SUPABASE_KEY = "sb_publishable_Qw4tlM2CtchoDM4TDGWPkA_gCeYarzs";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let kasir = sessionStorage.getItem("kasir") || "";
    let role = sessionStorage.getItem("role") || "";
    let allMenu = [];
    let filter = "Semua";
    let pesanan = [];
    let totalHarga = 0;
    let namaResto = localStorage.getItem("namaResto") || "RESTO BUNDA RITA";
    document.getElementById("restoName").innerText = namaResto;

    window.addEventListener('focus', ()=> {
      const nr = localStorage.getItem("namaResto") || "RESTO BUNDA RITA";
      if (nr !== namaResto) {
        namaResto = nr;
        document.getElementById("restoName").innerText = namaResto;
      }
    });

    document.addEventListener("DOMContentLoaded", async () => {
      if (!kasir) openPopup('loginPopup');
      else await loadMenu();
    });

    async function login() {
      const username = document.getElementById("username").value.trim();
      const password = document.getElementById("password").value.trim();
      if (!username || !password) return;
      showSpinner(true);
      const { data, error } = await supabase.from("akun").select("*").eq("username", username).eq("password", password).single();
      showSpinner(false);
      if (error || !data) return openNotif("Login gagal!");
      kasir = data.username;
      role = data.role;
      sessionStorage.setItem("kasir", kasir);
      sessionStorage.setItem("role", role);
      closePopup("loginPopup");
      await loadMenu();
    }

    async function loadMenu() {
      showSpinner(true);
      const { data, error } = await supabase.from("menu").select("*");
      showSpinner(false);
      if (!error) { allMenu = data; renderMenu(); }
    }

    function renderMenu() {
      const menuList = document.getElementById("menuList");
      menuList.innerHTML = "";
      allMenu.filter(m => filter === "Semua" || m.kategori === filter)
      .forEach(m => {
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `<img src="${m.gambar || 'https://via.placeholder.com/60'}"><b>${m.nama}</b><br>Rp ${m.harga}`;
        card.onclick = () => tambahPesanan(m);
        menuList.appendChild(card);
      });
    }

    function filterMenu(kat) { filter = kat; renderMenu(); }
    function tambahPesanan(menu) {
      const item = pesanan.find(p => p.nama === menu.nama);
      if (item) item.jumlah++;
      else pesanan.push({ nama: menu.nama, harga: menu.harga, jumlah:1 });
      renderPesanan();
    }
    function renderPesanan() {
      const list = document.getElementById("orderList");
      list.innerHTML = "";
      totalHarga = 0;
      pesanan.forEach((p,i) => {
        totalHarga += p.harga * p.jumlah;
        const row = document.createElement("div");
        row.className = "order-item";
        row.innerHTML = `<span>${p.nama} x${p.jumlah} - Rp ${p.harga*p.jumlah}</span>
          <button class="btn" onclick="hapusItem(${i})">❌</button>`;
        list.appendChild(row);
      });
      document.getElementById("total").innerText = totalHarga;
      hitungKembalian();
    }
    function hapusItem(i){ pesanan.splice(i,1); renderPesanan(); }
    function resetPesanan(){ pesanan=[]; renderPesanan(); document.getElementById("bayar").value=""; document.getElementById("diskon").value=""; document.getElementById("kembalian").innerText="0"; closePopup("resetPopup"); }
    function hitungKembalian() {
      const bayar = parseInt(document.getElementById("bayar").value)||0;
      const diskon = parseInt(document.getElementById("diskon").value)||0;
      const totalSetelahDiskon = totalHarga - diskon;
      const kembalian = bayar - totalSetelahDiskon;
      document.getElementById("kembalian").innerText = kembalian >= 0 ? kembalian : 0;
    }

    function konfirmasiBayar() {
      if (pesanan.length===0) return openNotif("Belum ada pesanan!");
      const bayar = parseInt(document.getElementById("bayar").value)||0;
      if (bayar<=0) return openNotif("Masukkan jumlah bayar!");
      openPopup('cetakPopup');
    }

    async function lanjutBayar(cetak) {
      closePopup('cetakPopup');
      showSpinner(true);
      const idTransaksi = crypto.randomUUID();
      const diskon = parseInt(document.getElementById("diskon").value)||0;
      for (let p of pesanan) {
        await supabase.from("transaksi_item").insert([{
          id_transaksi: idTransaksi,
          kasir,
          menu: p.nama,
          jumlah: p.jumlah,
          harga: p.harga,
          subtotal: p.harga*p.jumlah,
          jenis: "penjualan"
        }]);
      }
      showSpinner(false);

      if (cetak) tampilkanStruk(idTransaksi);
      else { openNotif("Transaksi tersimpan!"); resetPesanan(); }
    }

    function padCenter(text, width=32) { if (!text) return ''.padEnd(width,' '); if (text.length >= width) return text; const left = Math.floor((width - text.length)/2); const right = width - text.length - left; return ' '.repeat(left) + text + ' '.repeat(right); }
    function padRight(text, width=32) { text = String(text); if (text.length >= width) return text; return text + ' '.repeat(width - text.length); }
    function formatCurrency(num) { return 'Rp ' + Number(num || 0).toLocaleString('id-ID'); }

    function formatThermalReceipt(idTransaksi, waktu, kasirName, items, total, diskon, bayar, kembalian) {
      const width = 32; let lines = [];
      lines.push(padCenter(namaResto, width));
      lines.push(padCenter('--- STRUK ---', width));
      lines.push(`No: ${idTransaksi}`);
      lines.push(`Kasir: ${kasirName}`);
      lines.push(`${waktu}`);
      lines.push('-'.repeat(width));
      items.forEach(it => {
        const left = `${it.nama} x${it.jumlah}`;
        const right = `${formatCurrency(it.harga*it.jumlah)}`;
        if (left.length + right.length + 1 <= width) {
          const gap = width - left.length - right.length;
          lines.push(left + ' '.repeat(gap) + right);
        } else {
          lines.push(left); lines.push(right);
        }
      });
      lines.push('-'.repeat(width));
      lines.push(padRight('Total:', width-12) + formatCurrency(total));
      lines.push(padRight('Diskon:', width-12) + formatCurrency(diskon));
      lines.push(padRight('Total Akhir:', width-12) + formatCurrency(total - diskon));
      lines.push(padRight('Bayar:', width-12) + formatCurrency(bayar));
      lines.push(padRight('Kembalian:', width-12) + formatCurrency(kembalian));
      lines.push('-'.repeat(width));
      lines.push(padCenter('Terima kasih!', width));
      lines.push('\n\n');
      return lines.join('\n');
    }

    function tampilkanStruk(idTransaksi){
      const bayar = parseInt(document.getElementById("bayar").value)||0;
      const diskon = parseInt(document.getElementById("diskon").value)||0;
      const totalAkhir = totalHarga - diskon;
      const kembalian = bayar - totalAkhir;
      const waktu = new Date().toLocaleString("id-ID");

      let html = `<center><b>${escapeHtml(namaResto)}</b><br>Kasir: ${escapeHtml(kasir)}<br>${waktu}</center><hr>`;
      pesanan.forEach(p => html += `${escapeHtml(p.nama)} x${p.jumlah} - Rp ${p.harga*p.jumlah}<br>`);
      html += `<hr>Total: Rp ${totalHarga}<br>Diskon: Rp ${diskon}<br><b>Total Akhir: Rp ${totalAkhir}</b><br>Bayar: Rp ${bayar}<br>Kembalian: Rp ${kembalian}<hr><center>Terima kasih!</center>`;

      document.getElementById("strukPreview").innerHTML = html;
      openPopup('previewPopup');
      window._lastThermalText = formatThermalReceipt(idTransaksi, waktu, kasir, pesanan.slice(), totalHarga, diskon, bayar, kembalian);
      resetPesanan();
    }

    function escapeHtml(unsafe) { return String(unsafe).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); }

    function printThermal(printText) {
      try {
        const ESC = '\x1B';
        const GS = '\x1D';
        let cmd = '';
        cmd += ESC + '@';
        cmd += ESC + 't' + '\x00';
        cmd += ESC + 'a' + '\x01';
        cmd += padCenter(namaResto, 32) + '\n';
        cmd += ESC + 'a' + '\x00';
        cmd += 'No: ' + new Date().getTime() + '\n';
        cmd += printText;
        cmd += '\n\n';
        cmd += GS + 'V' + '\x01';
        const url = 'rawbt://print?text=' + encodeURIComponent(cmd);
        window.location.href = url;
        return true;
      } catch (err) { console.error("printThermal error:", err); return false; }
    }

    function cetakStruk(){
      const text = window._lastThermalText || document.getElementById("strukPreview").innerText;
      const ok = printThermal(text);
      closePopup('previewPopup');
      openNotif(ok ? "Perintah cetak dikirim ke RawBT" : "Gagal mengirim ke printer");
    }

    async function simpanPengeluaran() {
      const ket = document.getElementById("ketPengeluaran").value;
      const jumlah = parseInt(document.getElementById("jumlahPengeluaran").value);
      const harga = parseInt(document.getElementById("hargaPengeluaran").value);
      if (!ket || !jumlah || !harga) return;
      showSpinner(true);
      await supabase.from("transaksi_item").insert([{
        id_transaksi: crypto.randomUUID(),
        kasir,
        menu: ket,
        jumlah,
        harga,
        subtotal: jumlah*harga,
        jenis: "pengeluaran"
      }]);
      showSpinner(false);
      closePopup("pengeluaranPopup");
      openNotif("Pengeluaran tersimpan!");
    }

    function openNotif(msg){ document.getElementById("notifMessage").innerText=msg; openPopup("notifPopup"); }
    function openPopup(id){ document.getElementById(id).style.display="flex"; }
    function closePopup(id){ document.getElementById(id).style.display="none"; }
    function showSpinner(show){ document.getElementById("spinner").style.display=show?"block":"none"; }
    function logout(){ sessionStorage.clear(); window.location.href="index.html"; }
  </script>
</body>
</html>
